<div class="box" id="story_box">
  <div class="legend">
    Submit a Story
  </div>

  <div id="story_holder">
    <%= form_for @story do |f| %>
      <%= render :partial => "stories/form", :locals => { :story => @story,
        :f => f } %>

      <p></p>

      <div class="box">
        <div class="boxline markdown_help_toggler">
          <div class="markdown_help_label">
            Markdown formatting available
          </div>

          <%= submit_tag "Submit" %>

          &nbsp;
          <button type="button" class="story-preview">Preview</button>

          <div style="clear: both;"></div>

          <%= render :partial => "global/markdownhelp",
            :locals => { :allow_images => true } %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div id="story_preview">
  <% if @story.previewing && @story.valid? %>
    <%= render :template => "stories/show" %>
  <% end %>
</div>

<script>
  $(document).ready(function() {
    <% if @story.previewing %>
      $("#story_tags_a").select2({
        formatSelection: function(what) {
          return what.id;
        }
      });
    <% else %>
      $("#story_url").focus();

      $("button.story-preview").unbind().live("click", function() {
        Lobsters.previewStory($(this).parents("form").first());
      });

      $("#story_url").unbind().live("blur", function() {
        /* if the url looks like a pdf, assign the pdf tag */
        if ($("#story_url").val().match(/\.pdf$/i)) {
          var ta = $("#story_tags_a").data("select2");

          if (ta.getVal().indexOf("pdf") < 0)
            ta.addSelectedChoice({ id: "pdf" });
        }
        /* if the url looks like a video site url, assign the video tag */
        else if ($("#story_url").val().match(/[\/\.](youtube|vimeo)\.com\//i)) {
          var ta = $("#story_tags_a").data("select2");

          if (ta.getVal().indexOf("video") < 0)
            ta.addSelectedChoice({ id: "video" });
        }
      });
    <% end %>
  });
</script>
